<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
<style>


   
</style>
</head>
<body>
    

<h1 id="roomid"><%=roomid%> </h1>
<h1 id="username"><%=username%> </h1>

<div id="dd">


    <img src="" alt="">

</div>




<form id="myform">

    <div class="form-group">
        <label for="exampleInputPassword1">Enter a message</label>
        <input type="text" class="form-control" id="password" name="roomid"placeholder="roomid">
      </div>
    <div class="form-group">
        <label for="exampleInputPassword1">post a file</label>
        <input type="file" name="file" id="file">
      </div>
      
      <button type="submit" class="btn btn-primary" id="info">Submit</button>
   
</form>
</body>


<script>
const socket = io('http://localhost:8700')      
//const socket = io('https://neweducationworld.herokuapp.com', { transports: ['websocket', 'polling', 'flashsocket'] });

let roomid=document.getElementById('roomid').innerText
let username=document.getElementById('username').innerText
socket.emit('join-room', roomid, username )
socket.on('new_message',function(message){
    console.log(message)
})
let html=""

$( "#myform" ).submit(function( e ) {
e.preventDefault()
var chat =e.target.children[0].children[1].value
//localStorage.setItem("chat",chat)
var fileinfo =e.target.children[1].children[1].files[0]
if(fileinfo){

    Uploaded(fileinfo)
}


var base64String = "";
function Uploaded(newdata) {
	// var file = document.querySelector(
	// 	'input[type=file]')['files'][0];
  
//let data="";
    var file=newdata
	var reader = new FileReader();
	reader.onload = function () {
		base64String = reader.result.replace("data:", "")
			.replace(/^.+,/, "");
		imageBase64Stringsep = base64String;
       
       //console.log(base64String)
      ///localStorage.setItem('data',base64String)
	}
    //console.log(base64String)

	reader.readAsDataURL(file);
   
    
}
let image=""
//image=localStorage.getItem('data')


var encoded=atob(image)
console.log(encoded)

// var obj={
// "message":chat,
// "data":imgdata

//console.log(fileinfo)

if(fileinfo){


    console.log(fileinfo.size)
    socket.emit("message",username,chat,fileinfo)

}
else{
fileinfo=""
socket.emit("message",username,chat,fileinfo)

}

})


socket.on('newdata',function(username,chat,base64String){
    if(base64String!=""){

        html+=`
<div>${username}: ${chat} </div>
<img src="data:image/jpeg;base64,${base64String}"" alt="" width="400" 
     height="500"/>`
document.getElementById("dd").innerHTML=html


    }
    else{

        html+=`
<div> ${username}:${chat} </div>`

document.getElementById("dd").innerHTML=html

    }




})
//console.log(html)

// let chat=localStorage.getItem('chat')
// let img=localStorage.getItem('data')
// console.log(chat)
// console.log(img)
// socket.emit("message",chat,img)




</script>
</html>